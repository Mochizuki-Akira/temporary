<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¬›ç¾©ãƒ•ã‚¡ã‚¤ãƒ«é–²è¦§ï½œå­¦ç¿’å°å±‹</title>
  <link rel="stylesheet" href="../common/style.css" />
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
    }

    /* é¡¶éƒ¨è¿”å›æŒ‰é’® */
    .overlay {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 30;
    }
    .btn {
      display: inline-block;
      padding: 8px 14px;
      border: 1px solid #fff;
      border-radius: 8px;
      color: #fff;
      text-decoration: none;
      font-size: 14px;
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(4px);
      transition: background 0.2s;
    }
    .btn:hover { background: rgba(255,255,255,.2); }

    /* PDF å®¹å™¨ï¼ˆæ¡Œé¢ç”¨ iframeï¼‰ */
    #pdfFrame {
      width: 100vw;
      height: 100vh;
      border: none;
      background: #fff;
    }

    /* åŠ è½½é®ç½© */
    #loader {
      position: fixed;
      inset: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 14px;
      color: #fff;
      background: linear-gradient(135deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      text-align: center;
      padding: 24px;
    }
    .spin {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 4px solid rgba(255,255,255,.25);
      border-top-color: #fff;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hint { opacity: .9; font-size: .95rem; }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn-primary {
      border-color: #4a90e2;
      background: #4a90e2;
    }
  </style>
</head>

<body>
  <!-- é¡¶éƒ¨è¿”å›ï¼šè‡ªåŠ¨å›åˆ°å¯¹åº”åˆ—è¡¨ -->
  <div class="overlay">
    <a id="backBtn" class="btn">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>

  <!-- PDF åŒºåŸŸï¼ˆæ¡Œé¢ç«¯ç”¨ï¼‰ -->
  <iframe id="pdfFrame" title="PDF Viewer"></iframe>

  <!-- åŠ è½½æŒ‡ç¤º & è¶…æ—¶å…œåº• -->
  <div id="loader" aria-live="polite" aria-busy="true">
    <div class="spin" aria-hidden="true"></div>
    <div id="loadMsg">è¬›ç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</div>
    <div class="hint" id="loadHint">é€šä¿¡çŠ¶æ³ã«ã‚ˆã‚Š 1ã€œ2 ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</div>
    <div class="actions" style="display:none" id="slowActions">
      <a id="openDirect" class="btn btn-primary" target="_self">ğŸ“„ ç›´æ¥é–‹ã</a>
      <button id="retryBtn" class="btn">â†» å†èª­ã¿è¾¼ã¿</button>
    </div>
  </div>

  <script>
    // â€”â€” æ˜ å°„è¡¨ï¼ˆç›¸å¯¹ /che/viewer.htmlï¼›æ³¨æ„æ²¡æœ‰ ../ï¼‰â€”â€”
    const FILES = {
      '2510_1': 'assets/lectures/2510/chem_1.pdf',
      '2510_2': 'assets/lectures/2510/chem_2.pdf',
      '2510_2b': 'assets/lectures/2510/chem_2b.pdf',
      '2510_3': 'assets/lectures/2510/chem_3.pdf',
      '2510_hw1': 'assets/lectures/2510/hw_1.pdf',
      '2510_hw2a': 'assets/lectures/2510/hw_2a.pdf',
      '2510_hw2b': 'assets/lectures/2510/hw_2b.pdf',
      '2510_hw3': 'assets/lectures/2510/hw_3.pdf'
      // å¦‚æœä»¥åæœ‰ 2507 çš„ï¼Œä¹Ÿå¯ä»¥ç…§æ ·åœ¨è¿™é‡Œç»§ç»­åŠ 
    };

    const qs = new URLSearchParams(location.search);
    const id = qs.get('id') || '';
    const path = FILES[id];

    const frame       = document.getElementById('pdfFrame');
    const loader      = document.getElementById('loader');
    const loadMsg     = document.getElementById('loadMsg');
    const loadHint    = document.getElementById('loadHint');
    const slowActions = document.getElementById('slowActions');
    const openDirect  = document.getElementById('openDirect');
    const retryBtn    = document.getElementById('retryBtn');
    const backBtn     = document.getElementById('backBtn');

    // è¿”å›ç›®æ ‡ï¼šä¼˜å…ˆ referrerï¼Œå†çœ‹ id å‰ç¼€
    let back = './lectures.html';
    const ref = document.referrer || '';
    if (ref.includes('list-2507.html')) back = './list-2507.html';
    else if (ref.includes('list-2510.html')) back = './list-2510.html';
    else if (/^2507_/.test(id)) back = './list-2507.html';
    else if (/^2510_/.test(id)) back = './list-2510.html';
    backBtn.href = back;

    if (!path) {
      // æ²¡æœ‰æœ‰æ•ˆæ–‡ä»¶ï¼šç›´æ¥ç»™å‡ºæç¤ºå’Œè¿”å›æŒ‰é’®
      loadMsg.textContent = 'å¯¾è±¡ã®è¬›ç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
      loadHint.textContent = 'ä¸€è¦§ã«æˆ»ã£ã¦åˆ¥ã®è³‡æ–™ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      slowActions.style.display = 'flex';
      openDirect.textContent = 'â† ä¸€è¦§ã«æˆ»ã‚‹';
      openDirect.href = back;
    } else {
      document.title = `è¬›ç¾©ãƒ•ã‚¡ã‚¤ãƒ« (${id})ï½œå­¦ç¿’å°å±‹`;
      openDirect.href = path;

      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);

      if (isMobile) {
        // â€”â€” æ‰‹æœºï¼šç›´æ¥ç”¨ç³»ç»Ÿ PDF æŸ¥çœ‹å™¨æ‰“å¼€ï¼ˆæœ€æ¸…æ™°ã€æ”¯æŒç¼©æ”¾ã€åˆ†é¡µï¼‰â€”â€”
        loadMsg.textContent = 'ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã®ãŸã‚ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ“ãƒ¥ãƒ¼ã‚¢ã§é–‹ãã¾ã™â€¦';
        // åŒé¡µé¢è·³è½¬åˆ° PDF
        location.replace(path);
      } else {
        // â€”â€” æ¡Œé¢ç«¯ï¼šåœ¨ iframe ä¸­å†…åµŒ + åŠ è½½åé¦ˆ â€”â€” 
        const t0 = performance.now();
        frame.src = path;

        // 3 ç§’ä»æœªåŠ è½½ï¼šæç¤ºâ€œè¿˜åœ¨åŠ è½½â€ï¼Œå±•ç¤ºç›´é“¾/é‡è¯•
        const slowTimer = setTimeout(() => {
          loadMsg.textContent = 'ã¾ã èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦';
          loadHint.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒæ··ã¿åˆã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ç›´æ¥é–‹ã/å†èª­ã¿è¾¼ã¿ã‚‚ã§ãã¾ã™ã€‚';
          slowActions.style.display = 'flex';
        }, 3000);

        // 10 ç§’ä»æœªå®Œæˆï¼šå¼ºè°ƒå…œåº•
        const hardTimer = setTimeout(() => {
          loadMsg.textContent = 'èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚';
          loadHint.textContent = 'ã€ŒğŸ“„ ç›´æ¥é–‹ãã€ã‚’æŠ¼ã™ã¨åŒãƒšãƒ¼ã‚¸ã§è¡¨ç¤ºã—ã¾ã™ã€‚';
          slowActions.style.display = 'flex';
        }, 10000);

        // åŠ è½½å®Œæˆï¼šå…³é—­é®ç½©
        frame.addEventListener('load', () => {
          clearTimeout(slowTimer);
          clearTimeout(hardTimer);
          loader.style.display = 'none';
        });

        // å¤±è´¥å…œåº•
        frame.addEventListener('error', () => {
          loadMsg.textContent = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
          loadHint.textContent = 'ã€ŒğŸ“„ ç›´æ¥é–‹ãã€ã¾ãŸã¯ã€Œâ†» å†èª­ã¿è¾¼ã¿ã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
          slowActions.style.display = 'flex';
        });

        // é‡è¯•æŒ‰é’®ï¼šé™„å¸¦ç®€å• cache-busting
        retryBtn.addEventListener('click', () => {
          slowActions.style.display = 'none';
          loadMsg.textContent = 'å†èª­ã¿è¾¼ã¿ä¸­â€¦';
          const bust = (path.includes('?') ? '&' : '?') + 't=' + Date.now();
          frame.src = path + bust;
        });
      }
    }
  </script>
</body>
</html>